<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital Reservation</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
</head>

<body>
    <h1>Welcome to Hospital Reservation</h1>

    <div id="search">
        <h2>Search Hospitals</h2>
        <a href="/search">
            <button class="custom-btn btn-3">
                <span>병원 찾기</span>
            </button>
        </a>

        <form id="searchForm" action="/book" method="GET" style="text-align: center;">
            <div class="Sdiv">
                <input class="Sinput" type="text" id="hospitalName" name="name" required>
                <label class="Slabel">병원 이름</label>
                <span class="Sspan"></span>
            </div>
            <button class="custom-btn btn-3" type="submit"><span>검색</span></button>
        </form>
    </div>

    <div id="results">
        {% if hospitals.length > 0 %}
        <table border="1">
            <tr>
                <th>병원 이름</th>
                <th>주소</th>
                <th>전화번호</th>
            </tr>
            {% for hospital in hospitals %}
            <tr>
                <td onclick="selectHospital('{{ hospital.yadmNm }}')">{{ hospital.yadmNm }}</td>
                <td>{{ hospital.addr }}</td>
                <td>{{ hospital.telno }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <p>검색 결과가 없습니다.</p>
        {% endif %}
    </div>

    <input type="text" id="target_acc" style="width: 500px; text-align: center; margin: 8px;"><br>

    <div id="reserve" style="display:none;">
        <h2>Reserve Hospital</h2>
        <div id="calendar"></div>
        <div id="selectedDateTime"></div>
        <form id="reservationForm" action="http://localhost:3001/reserve" method="POST">
            <input type="hidden" name="hospitalName" id="hospitalNameField">
            <input type="hidden" name="selectedSlot" id="selectedSlotField">
            <div class="time-period">
                <h3>오전</h3>
                <div id="timeSlotsMorning" class="timeSlots"></div>
            </div>
            <div class="time-period">
                <h3>오후</h3>
                <div id="timeSlotsAfternoon" class="timeSlots"></div>
            </div>
            <button type="submit" style="margin-bottom: 50px;">Reserve</button>
        </form>
    </div>

    <script>
        $(document).ready(function () {
            let selectedSlot = null;
            let selectedHospital = null;

            // 병원 선택 시 호출되는 함수
            function selectHospital(name) {
                selectedHospital = name;
                console.log('Selected Hospital:', name);
                $('#target_acc').val(name);
                $('#hospitalNameField').val(name);
                $('#reserve').show();
                initializeCalendar();
            }

            // 시간 슬롯 생성 함수
            function generateTimeSlots(date) {
                const timeSlotsMorning = ['10:00', '10:30', '11:00', '11:30'];
                const timeSlotsAfternoon = ['12:00', '12:30', '2:00', '2:30', '3:00'];
                const reservedSlots = ['2024-07-25T10:00', '2024-07-25T14:00'];

                $('#timeSlotsMorning').empty();
                $('#timeSlotsAfternoon').empty();

                timeSlotsMorning.forEach(time => {
                    let timeSlotId = `${date}T${time}`;
                    $('#timeSlotsMorning').append(`
                        <div class="time-slot">
                            <button type="button" class="btn ${reservedSlots.includes(timeSlotId) ? 'disabled' : ''}" id="${timeSlotId}" data-id="${timeSlotId}">
                                ${time}
                            </button>
                        </div>
                    `);
                });

                timeSlotsAfternoon.forEach(time => {
                    let timeSlotId = `${date}T${time}`;
                    $('#timeSlotsAfternoon').append(`
                        <div class="time-slot">
                            <button type="button" class="btn ${reservedSlots.includes(timeSlotId) ? 'disabled' : ''}" id="${timeSlotId}" data-id="${timeSlotId}">
                                ${time}
                            </button>
                        </div>
                    `);
                });

                $('.btn').on('click', function () {
                    if ($(this).hasClass('disabled')) return;
                    $('.btn').removeClass('selected');
                    $(this).addClass('selected');
                    selectedSlot = $(this).data('id');
                    $('#selectedSlotField').val(selectedSlot);
                    $('#selectedDateTime').text(`선택된 날짜와 시간: ${selectedSlot}`);
                    console.log('Selected Slot:', selectedSlot);
                    console.log('Selected Hospital:', selectedHospital);
                });
            }

            function initializeCalendar() {
                $('#calendar').fullCalendar({
                    selectable: true,
                    selectHelper: true,
                    select: function (start) {
                        $('#timeSlotsMorning').empty();
                        $('#timeSlotsAfternoon').empty();
                        selectedDate = start.format('YYYY-MM-DD');
                        $('#selectedDateTime').text(`선택된 날짜: ${start.format('YYYY. M. D (dd)')}`);
                        generateTimeSlots(selectedDate);
                    }
                });
            }

            $('#reservationForm').on('submit', function () {
                $('#hospitalNameField').val(selectedHospital);
                $('#selectedSlotField').val(selectedSlot);
            });

            window.selectHospital = selectHospital;
        });
    </script>
</body>
</html>
